# üîê Tri·ªÉn khai Ph√™ duy·ªát Cu·ªôc h·∫πn & Ph∆∞∆°ng th·ª©c V√†o D·ª± √°n

## üìã T·ªïng quan

T√†i li·ªáu n√†y m√¥ t·∫£ vi·ªác tri·ªÉn khai t√≠nh nƒÉng **ph√™ duy·ªát cu·ªôc h·∫πn t·ª´ ch·ªß d·ª± √°n** v√† **qu·∫£n l√Ω ph∆∞∆°ng th·ª©c v√†o d·ª± √°n**.

---

## üóÑÔ∏è Thay ƒë·ªïi Database

### B·∫£ng `duan` - Th√™m c·ªôt m·ªõi:
```sql
ALTER TABLE `duan` 
ADD COLUMN `PhuongThucVao` TEXT DEFAULT NULL 
COMMENT 'Ph∆∞∆°ng th·ª©c v√†o d·ª± √°n khi kh√¥ng c·∫ßn ph√™ duy·ªát (m·∫≠t kh·∫©u c·ª≠a, v·ªã tr√≠ l·∫•y ch√¨a kh√≥a, v.v.)' 
AFTER `YeuCauPheDuyetChu`;
```

**M·ª•c ƒë√≠ch:**
- L∆∞u tr·ªØ ph∆∞∆°ng th·ª©c v√†o **m·∫∑c ƒë·ªãnh** c·ªßa d·ª± √°n
- Ch·ªâ √°p d·ª•ng khi `YeuCauPheDuyetChu = 0` (kh√¥ng y√™u c·∫ßu ph√™ duy·ªát)
- V√≠ d·ª•: "M·∫≠t kh·∫©u c·ªïng: 1234, Ch√¨a kh√≥a t·∫°i h·ªôp th∆∞ s·ªë 5"

### B·∫£ng `cuochen` - Th√™m 4 c·ªôt m·ªõi:

```sql
ALTER TABLE `cuochen` 
ADD COLUMN `PheDuyetChuDuAn` ENUM('ChoPheDuyet','DaPheDuyet','TuChoi') DEFAULT NULL
COMMENT 'Tr·∫°ng th√°i ph√™ duy·ªát t·ª´ ch·ªß d·ª± √°n (NULL n·∫øu d·ª± √°n kh√¥ng y√™u c·∫ßu ph√™ duy·ªát)'
AFTER `TrangThai`;

ALTER TABLE `cuochen` 
ADD COLUMN `LyDoTuChoi` TEXT DEFAULT NULL
COMMENT 'L√Ω do t·ª´ ch·ªëi cu·ªôc h·∫πn (n·∫øu PheDuyetChuDuAn = TuChoi)'
AFTER `PheDuyetChuDuAn`;

ALTER TABLE `cuochen` 
ADD COLUMN `PhuongThucVao` TEXT DEFAULT NULL
COMMENT 'Ph∆∞∆°ng th·ª©c v√†o d·ª± √°n cho cu·ªôc h·∫πn n√†y (ghi ƒë√® PhuongThucVao c·ªßa duan n·∫øu c√≥)'
AFTER `LyDoTuChoi`;

ALTER TABLE `cuochen` 
ADD COLUMN `ThoiGianPheDuyet` DATETIME DEFAULT NULL
COMMENT 'Th·ªùi ƒëi·ªÉm ch·ªß d·ª± √°n ph√™ duy·ªát/t·ª´ ch·ªëi cu·ªôc h·∫πn'
AFTER `PhuongThucVao`;
```

**M·ª•c ƒë√≠ch:**
- `PheDuyetChuDuAn`: Tr·∫°ng th√°i ph√™ duy·ªát c·ªßa ch·ªß d·ª± √°n
  - `NULL`: Kh√¥ng c·∫ßn ph√™ duy·ªát
  - `ChoPheDuyet`: ƒêang ch·ªù ch·ªß d·ª± √°n ph√™ duy·ªát
  - `DaPheDuyet`: ƒê√£ ƒë∆∞·ª£c ph√™ duy·ªát
  - `TuChoi`: B·ªã t·ª´ ch·ªëi
- `LyDoTuChoi`: Ghi l√Ω do khi t·ª´ ch·ªëi
- `PhuongThucVao`: Ph∆∞∆°ng th·ª©c v√†o **c·ª• th·ªÉ cho cu·ªôc h·∫πn n√†y** (∆∞u ti√™n h∆°n `duan.PhuongThucVao`)
- `ThoiGianPheDuyet`: Timestamp khi ph√™ duy·ªát/t·ª´ ch·ªëi

---

## üéØ Nghi·ªáp v·ª• Logic

### **LU·ªíNG 1: D·ª± √°n Y√äU C·∫¶U ph√™ duy·ªát** (`YeuCauPheDuyetChu = 1`)

1. **T·∫°o cu·ªôc h·∫πn:**
   - Kh√°ch h√†ng/Sales t·∫°o cu·ªôc h·∫πn
   - `TrangThai = 'DaYeuCau'`
   - `PheDuyetChuDuAn = 'ChoPheDuyet'`
   - `duan.PhuongThucVao` = NULL (kh√¥ng c·∫ßn cung c·∫•p tr∆∞·ªõc)

2. **Ch·ªß d·ª± √°n xem danh s√°ch cu·ªôc h·∫πn ch·ªù ph√™ duy·ªát:**
   - Filter: `PheDuyetChuDuAn = 'ChoPheDuyet'`
   - Hi·ªÉn th·ªã: Th√¥ng tin kh√°ch h√†ng, sales, th·ªùi gian h·∫πn

3. **Ch·ªß d·ª± √°n ph√™ duy·ªát:**
   - **Option A - Ph√™ duy·ªát:**
     - `PheDuyetChuDuAn = 'DaPheDuyet'`
     - Nh·∫≠p `cuochen.PhuongThucVao` (b·∫Øt bu·ªôc)
     - `ThoiGianPheDuyet = NOW()`
   - **Option B - T·ª´ ch·ªëi:**
     - `PheDuyetChuDuAn = 'TuChoi'`
     - Nh·∫≠p `LyDoTuChoi` (b·∫Øt bu·ªôc)
     - `ThoiGianPheDuyet = NOW()`

4. **Sales/Kh√°ch xem ph∆∞∆°ng th·ª©c v√†o:**
   - Ch·ªâ hi·ªÉn th·ªã `cuochen.PhuongThucVao` khi `PheDuyetChuDuAn = 'DaPheDuyet'`
   - Hi·ªÉn th·ªã `LyDoTuChoi` khi `PheDuyetChuDuAn = 'TuChoi'`

### **LU·ªíNG 2: D·ª± √°n KH√îNG y√™u c·∫ßu ph√™ duy·ªát** (`YeuCauPheDuyetChu = 0`)

1. **T·∫°o d·ª± √°n:**
   - `duan.PhuongThucVao` l√† **B·∫ÆT BU·ªòC**
   - Ch·ªß d·ª± √°n ph·∫£i nh·∫≠p tr∆∞·ªõc

2. **T·∫°o cu·ªôc h·∫πn:**
   - `TrangThai = 'DaXacNhan'` (t·ª± ƒë·ªông x√°c nh·∫≠n)
   - `PheDuyetChuDuAn = NULL` (kh√¥ng c·∫ßn ph√™ duy·ªát)
   - `cuochen.PhuongThucVao` = NULL (d√πng `duan.PhuongThucVao`)

3. **Sales/Kh√°ch xem ph∆∞∆°ng th·ª©c v√†o:**
   - Hi·ªÉn th·ªã `duan.PhuongThucVao` ngay l·∫≠p t·ª©c
   - Kh√¥ng c·∫ßn ch·ªù ph√™ duy·ªát

---

## üíª Tri·ªÉn khai Frontend

### **File:** `client/src/components/ChuDuAn/ModalTaoNhanhDuAn.jsx`

#### **State m·ªõi:**
```javascript
const [formData, setFormData] = useState({
  TenDuAn: '',
  DiaChiChiTiet: '',
  MoTa: '',
  YeuCauPheDuyetChu: false,  // Checkbox
  PhuongThucVao: '',          // Textarea - ƒêi·ªÅu ki·ªán hi·ªÉn th·ªã
  TrangThai: 'HoatDong'
});
```

#### **Validation:**
```javascript
// N·∫øu KH√îNG y√™u c·∫ßu ph√™ duy·ªát ‚Üí PhuongThucVao l√† B·∫ÆT BU·ªòC
if (!formData.YeuCauPheDuyetChu && !formData.PhuongThucVao.trim()) {
  setError('Vui l√≤ng nh·∫≠p ph∆∞∆°ng th·ª©c v√†o d·ª± √°n (m·∫≠t kh·∫©u c·ª≠a, v·ªã tr√≠ ch√¨a kh√≥a...)');
  return;
}
```

#### **UI Logic:**
```javascript
{/* Ch·ªâ hi·ªán textarea khi KH√îNG tick checkbox ph√™ duy·ªát */}
{!formData.YeuCauPheDuyetChu && (
  <div>
    <label>Ph∆∞∆°ng th·ª©c v√†o d·ª± √°n <span style={{ color: '#dc2626' }}>*</span></label>
    <textarea
      name="PhuongThucVao"
      value={formData.PhuongThucVao}
      onChange={xuLyThayDoi}
      placeholder="VD: M·∫≠t kh·∫©u c·ªïng: 1234, Ch√¨a kh√≥a ƒë·ªÉ t·∫°i h·ªôp th∆∞ s·ªë 5..."
      rows="3"
    />
    <p style={{ fontSize: '0.75rem', color: '#6b7280' }}>
      üí° Th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c chia s·∫ª v·ªõi nh√¢n vi√™n b√°n h√†ng v√† kh√°ch h√†ng sau khi ƒë·∫∑t h·∫πn
    </p>
  </div>
)}
```

#### **API Call:**
```javascript
body: JSON.stringify({
  TenDuAn: formData.TenDuAn.trim(),
  DiaChi: diaChiDayDu,
  MoTa: formData.MoTa.trim() || '',
  YeuCauPheDuyetChu: formData.YeuCauPheDuyetChu ? 1 : 0,
  PhuongThucVao: formData.YeuCauPheDuyetChu ? null : formData.PhuongThucVao.trim(),
  TrangThai: formData.TrangThai
})
```

**Gi·∫£i th√≠ch:**
- N·∫øu `YeuCauPheDuyetChu = true` ‚Üí `PhuongThucVao = null` (kh√¥ng g·ª≠i)
- N·∫øu `YeuCauPheDuyetChu = false` ‚Üí `PhuongThucVao = gi√° tr·ªã nh·∫≠p` (b·∫Øt bu·ªôc)

---

## ‚öôÔ∏è Tri·ªÉn khai Backend

### **File:** `server/models/ChuDuAnModel.js`

#### **Method:** `taoDuAn(chuDuAnId, data)`

```javascript
static async taoDuAn(chuDuAnId, data) {
  try {
    const [result] = await db.execute(
      `INSERT INTO duan (TenDuAn, DiaChi, ChuDuAnID, YeuCauPheDuyetChu, PhuongThucVao, TrangThai, TaoLuc, CapNhatLuc)
       VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())`,
      [
        data.TenDuAn, 
        data.DiaChi || '', 
        chuDuAnId,
        data.YeuCauPheDuyetChu || 0,
        data.PhuongThucVao || null,  // ‚Üê Tr∆∞·ªùng m·ªõi
        data.TrangThai || 'HoatDong'
      ]
    );
    return result.insertId;
  } catch (error) {
    throw new Error(`L·ªói t·∫°o d·ª± √°n: ${error.message}`);
  }
}
```

### **File:** `server/controllers/ChuDuAnController.js`

#### **Endpoint:** `POST /api/chu-du-an/du-an/tao-nhanh`

```javascript
static async taoNhanhDuAn(req, res) {
  try {
    const chuDuAnId = req.user.id;
    const { TenDuAn, DiaChi, MoTa, YeuCauPheDuyetChu, PhuongThucVao, TrangThai } = req.body;

    // Validation c∆° b·∫£n
    if (!TenDuAn || !TenDuAn.trim()) {
      return res.status(400).json({
        success: false,
        message: 'T√™n d·ª± √°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'
      });
    }

    if (!DiaChi || !DiaChi.trim()) {
      return res.status(400).json({
        success: false,
        message: 'ƒê·ªãa ch·ªâ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'
      });
    }

    // ‚úÖ VALIDATION M·ªöI: N·∫øu kh√¥ng y√™u c·∫ßu ph√™ duy·ªát ‚Üí PhuongThucVao l√† B·∫ÆT BU·ªòC
    if (!YeuCauPheDuyetChu && (!PhuongThucVao || !PhuongThucVao.trim())) {
      return res.status(400).json({
        success: false,
        message: 'Ph∆∞∆°ng th·ª©c v√†o d·ª± √°n l√† b·∫Øt bu·ªôc khi kh√¥ng y√™u c·∫ßu ph√™ duy·ªát'
      });
    }

    // T·∫°o d·ª± √°n
    const duAnId = await ChuDuAnModel.taoDuAn(chuDuAnId, {
      TenDuAn: TenDuAn.trim(),
      DiaChi: DiaChi.trim(),
      MoTa: MoTa ? MoTa.trim() : '',
      YeuCauPheDuyetChu: YeuCauPheDuyetChu ? 1 : 0,
      PhuongThucVao: YeuCauPheDuyetChu ? null : (PhuongThucVao ? PhuongThucVao.trim() : null),
      TrangThai: TrangThai || 'HoatDong'
    });

    // ... (ph·∫ßn c√≤n l·∫°i)
  }
}
```

**Logic:**
- N·∫øu `YeuCauPheDuyetChu = true` ‚Üí `PhuongThucVao = null` (kh√¥ng l∆∞u)
- N·∫øu `YeuCauPheDuyetChu = false` ‚Üí `PhuongThucVao` **B·∫ÆT BU·ªòC** (ph·∫£i nh·∫≠p)

---

## üß™ Test Cases

### **Test 1: T·∫°o d·ª± √°n Y√äU C·∫¶U ph√™ duy·ªát**
1. M·ªü modal t·∫°o d·ª± √°n
2. Nh·∫≠p t√™n, ƒë·ªãa ch·ªâ
3. **TICK** checkbox "Y√™u c·∫ßu ph√™ duy·ªát t·ª´ ch·ªß d·ª± √°n"
4. ‚Üí Textarea "Ph∆∞∆°ng th·ª©c v√†o" **·∫®N**
5. Submit ‚Üí Success

**Expected Database:**
```sql
INSERT INTO duan (...) VALUES (
  'D·ª± √°n ABC',
  '123 ƒê∆∞·ªùng Test...',
  1,
  1,        -- YeuCauPheDuyetChu = 1
  NULL,     -- PhuongThucVao = NULL
  'HoatDong'
);
```

### **Test 2: T·∫°o d·ª± √°n KH√îNG y√™u c·∫ßu ph√™ duy·ªát - Kh√¥ng nh·∫≠p ph∆∞∆°ng th·ª©c**
1. M·ªü modal t·∫°o d·ª± √°n
2. Nh·∫≠p t√™n, ƒë·ªãa ch·ªâ
3. **KH√îNG TICK** checkbox "Y√™u c·∫ßu ph√™ duy·ªát"
4. ‚Üí Textarea "Ph∆∞∆°ng th·ª©c v√†o" **HI·ªÜN** v·ªõi d·∫•u sao ƒë·ªè (*)
5. **KH√îNG NH·∫¨P** ph∆∞∆°ng th·ª©c v√†o
6. Submit ‚Üí **ERROR**: "Vui l√≤ng nh·∫≠p ph∆∞∆°ng th·ª©c v√†o d·ª± √°n..."

### **Test 3: T·∫°o d·ª± √°n KH√îNG y√™u c·∫ßu ph√™ duy·ªát - C√≥ nh·∫≠p ph∆∞∆°ng th·ª©c**
1. M·ªü modal t·∫°o d·ª± √°n
2. Nh·∫≠p t√™n, ƒë·ªãa ch·ªâ
3. **KH√îNG TICK** checkbox "Y√™u c·∫ßu ph√™ duy·ªát"
4. ‚Üí Textarea "Ph∆∞∆°ng th·ª©c v√†o" **HI·ªÜN**
5. Nh·∫≠p: "M·∫≠t kh·∫©u c·ªïng: 1234, Ch√¨a kh√≥a t·∫°i h·ªôp th∆∞ s·ªë 5"
6. Submit ‚Üí Success

**Expected Database:**
```sql
INSERT INTO duan (...) VALUES (
  'D·ª± √°n XYZ',
  '456 ƒê∆∞·ªùng Test...',
  1,
  0,        -- YeuCauPheDuyetChu = 0
  'M·∫≠t kh·∫©u c·ªïng: 1234, Ch√¨a kh√≥a t·∫°i h·ªôp th∆∞ s·ªë 5',  -- PhuongThucVao
  'HoatDong'
);
```

### **Test 4: Toggle checkbox ph√™ duy·ªát**
1. M·ªü modal t·∫°o d·ª± √°n
2. **KH√îNG TICK** checkbox ‚Üí Textarea "Ph∆∞∆°ng th·ª©c v√†o" **HI·ªÜN**
3. Nh·∫≠p n·ªôi dung v√†o textarea
4. **TICK** checkbox ‚Üí Textarea **·∫®N** (n·ªôi dung v·∫´n c√≤n trong state)
5. **B·ªé TICK** checkbox ‚Üí Textarea **HI·ªÜN** l·∫°i v·ªõi n·ªôi dung c≈©
6. Submit ‚Üí Success

---

## üîú C√¥ng vi·ªác ti·∫øp theo (Future Work)

### **Phase 2: UI Ph√™ duy·ªát cu·ªôc h·∫πn**

1. **Trang qu·∫£n l√Ω cu·ªôc h·∫πn cho ch·ªß d·ª± √°n:**
   - Tab "Ch·ªù ph√™ duy·ªát" (filter: `PheDuyetChuDuAn = 'ChoPheDuyet'`)
   - Hi·ªÉn th·ªã: Th√¥ng tin kh√°ch h√†ng, sales, th·ªùi gian h·∫πn, d·ª± √°n
   - Action buttons: "Ph√™ duy·ªát" | "T·ª´ ch·ªëi"

2. **Modal ph√™ duy·ªát:**
   - Textarea: Ph∆∞∆°ng th·ª©c v√†o (b·∫Øt bu·ªôc khi ph√™ duy·ªát)
   - Button: "‚úì Ph√™ duy·ªát"

3. **Modal t·ª´ ch·ªëi:**
   - Textarea: L√Ω do t·ª´ ch·ªëi (b·∫Øt bu·ªôc)
   - Button: "‚úó T·ª´ ch·ªëi"

4. **API Endpoints c·∫ßn th√™m:**
   - `PUT /api/chu-du-an/cuoc-hen/:id/phe-duyet`
   - `PUT /api/chu-du-an/cuoc-hen/:id/tu-choi`

5. **Backend logic:**
   ```javascript
   // Ph√™ duy·ªát
   UPDATE cuochen SET 
     PheDuyetChuDuAn = 'DaPheDuyet',
     PhuongThucVao = ?,
     ThoiGianPheDuyet = NOW()
   WHERE CuocHenID = ?
   
   // T·ª´ ch·ªëi
   UPDATE cuochen SET 
     PheDuyetChuDuAn = 'TuChoi',
     LyDoTuChoi = ?,
     ThoiGianPheDuyet = NOW()
   WHERE CuocHenID = ?
   ```

6. **UI cho Sales/Kh√°ch:**
   - Hi·ªÉn th·ªã tr·∫°ng th√°i ph√™ duy·ªát:
     - "‚è≥ Ch·ªù ch·ªß d·ª± √°n ph√™ duy·ªát"
     - "‚úì ƒê√£ ph√™ duy·ªát - Ph∆∞∆°ng th·ª©c v√†o: [PhuongThucVao]"
     - "‚úó ƒê√£ t·ª´ ch·ªëi - L√Ω do: [LyDoTuChoi]"

### **Phase 3: Notification & Alerts**

1. **Email/SMS th√¥ng b√°o:**
   - Ch·ªß d·ª± √°n khi c√≥ cu·ªôc h·∫πn m·ªõi
   - Sales/Kh√°ch khi cu·ªôc h·∫πn ƒë∆∞·ª£c ph√™ duy·ªát/t·ª´ ch·ªëi

2. **In-app notification:**
   - Badge count cu·ªôc h·∫πn ch·ªù ph√™ duy·ªát
   - Real-time alert qua WebSocket

---

## üìä Metrics & Monitoring

### **KPIs c·∫ßn tracking:**
1. T·ª∑ l·ªá ph√™ duy·ªát/t·ª´ ch·ªëi cu·ªôc h·∫πn
2. Th·ªùi gian trung b√¨nh t·ª´ "DaYeuCau" ‚Üí "DaPheDuyet"
3. S·ªë l∆∞·ª£ng d·ª± √°n y√™u c·∫ßu ph√™ duy·ªát vs kh√¥ng y√™u c·∫ßu
4. T·ª∑ l·ªá cu·ªôc h·∫πn b·ªã t·ª´ ch·ªëi theo l√Ω do

### **Query v√≠ d·ª•:**
```sql
-- T·ª∑ l·ªá ph√™ duy·ªát
SELECT 
  PheDuyetChuDuAn,
  COUNT(*) as SoLuong,
  ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM cuochen WHERE PheDuyetChuDuAn IS NOT NULL), 2) as TyLe
FROM cuochen
WHERE PheDuyetChuDuAn IS NOT NULL
GROUP BY PheDuyetChuDuAn;

-- Th·ªùi gian ph√™ duy·ªát trung b√¨nh
SELECT 
  AVG(TIMESTAMPDIFF(HOUR, TaoLuc, ThoiGianPheDuyet)) as TrungBinhGio
FROM cuochen
WHERE PheDuyetChuDuAn = 'DaPheDuyet';
```

---

## ‚úÖ Checklist Ho√†n th√†nh

- [x] Database migration (th√™m c·ªôt `duan.PhuongThucVao`, `cuochen.PheDuyetChuDuAn`, etc.)
- [x] Backend Model: `ChuDuAnModel.taoDuAn()` h·ªó tr·ª£ `PhuongThucVao`
- [x] Backend Controller: Validation `PhuongThucVao` b·∫Øt bu·ªôc khi kh√¥ng ph√™ duy·ªát
- [x] Frontend Modal: Th√™m textarea `PhuongThucVao` v·ªõi ƒëi·ªÅu ki·ªán hi·ªÉn th·ªã
- [x] Frontend Modal: Validation v√† UX hints
- [x] Ki·ªÉm tra l·ªói bi√™n d·ªãch (No errors found)
- [ ] Manual testing tr√™n dev environment
- [ ] UI/UX cho ph√™ duy·ªát cu·ªôc h·∫πn (Phase 2)
- [ ] API endpoints ph√™ duy·ªát/t·ª´ ch·ªëi (Phase 2)
- [ ] Notification system (Phase 3)

---

## üìù Ghi ch√∫ b·ªï sung

### **L∆∞u √Ω b·∫£o m·∫≠t:**
1. Tr∆∞·ªùng `PhuongThucVao` ch·ª©a th√¥ng tin nh·∫°y c·∫£m (m·∫≠t kh·∫©u c·ª≠a, v·ªã tr√≠ ch√¨a kh√≥a)
2. Ch·ªâ hi·ªÉn th·ªã cho:
   - Ch·ªß d·ª± √°n (owner)
   - Sales ƒë√£ x√°c nh·∫≠n cu·ªôc h·∫πn
   - Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát
3. **KH√îNG** tr·∫£ v·ªÅ trong API public (danh s√°ch tin ƒëƒÉng)

### **Optimization:**
- Th√™m index cho `cuochen.PheDuyetChuDuAn` ƒë·ªÉ t·ªëi ∆∞u query filter
- Cache `duan.PhuongThucVao` trong Redis n·∫øu d·ª± √°n c√≥ nhi·ªÅu cu·ªôc h·∫πn

---

**Document Version:** 1.0  
**Last Updated:** October 1, 2025  
**Author:** GitHub Copilot  
