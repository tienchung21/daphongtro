# üîê AUTH MIDDLEWARE CLARIFICATION

## üìã T·ªïng quan

D·ª± √°n c√≥ **2 b·ªô middleware x√°c th·ª±c ri√™ng bi·ªát** cho Development v√† Production:

### üü¢ Development Middleware (DEV BYPASS)
**M·ª•c ƒë√≠ch:** B·ªè qua x√°c th·ª±c ƒë·ªÉ tƒÉng t·ªëc development, kh√¥ng c·∫ßn JWT token

**Files:**
- `server/middleware/authSimple.js` - T·∫°o mock user object
- `server/middleware/roleSimple.js` - B·ªè qua role checking

**Khi n√†o d√πng:**
- ‚úÖ Development environment (`NODE_ENV=development`)
- ‚úÖ Local testing without JWT setup
- ‚úÖ Rapid prototyping
- ‚ùå **KH√îNG BAO GI·ªú** d√πng trong production

### üî¥ Production Middleware (REAL AUTH)
**M·ª•c ƒë√≠ch:** X√°c th·ª±c th·ª±c s·ª± v·ªõi JWT v√† database

**Files:**
- `server/middleware/auth.js` - JWT token verification + database validation
- `server/middleware/role.js` - Database-based RBAC with ownership checks

**Khi n√†o d√πng:**
- ‚úÖ Production environment (`NODE_ENV=production`)
- ‚úÖ Staging environment
- ‚úÖ Khi c·∫ßn real authentication
- ‚úÖ Khi test end-to-end authentication flow

---

## üìÇ Chi ti·∫øt Implementation

### 1Ô∏è‚É£ authSimple.js (DEV BYPASS)

**Purpose:** T·∫°o mock user object, kh√¥ng ki·ªÉm tra token

```javascript
const authSimple = (req, res, next) => {
  // Bypass authentication - t·∫°o mock user
  req.user = {
    NguoiDungID: parseInt(process.env.MOCK_USER_ID) || 1,
    id: parseInt(process.env.MOCK_USER_ID) || 1,
    userId: parseInt(process.env.MOCK_USER_ID) || 1,
    username: 'test_user',
    vaiTro: process.env.MOCK_ROLE_NAME || 'ChuDuAn',
    roles: [process.env.MOCK_ROLE_NAME || 'ChuDuAn'],
    currentRole: process.env.MOCK_ROLE_NAME || 'ChuDuAn',
    isMockUser: true
  };
  
  next();
};
```

**Characteristics:**
- ‚úÖ ƒê∆°n gi·∫£n, kh√¥ng logic ph·ª©c t·∫°p
- ‚úÖ Kh√¥ng ki·ªÉm tra NODE_ENV (intentionally simple)
- ‚úÖ T·∫°o mock user t·ª´ env variables
- ‚úÖ Flag `isMockUser: true` ƒë·ªÉ middleware kh√°c bi·∫øt

**Environment Variables:**
```env
MOCK_USER_ID=1
MOCK_ROLE_NAME=ChuDuAn
```

---

### 2Ô∏è‚É£ roleSimple.js (DEV BYPASS)

**Purpose:** B·ªè qua role checking, cho ph√©p t·∫•t c·∫£ requests

```javascript
const roleSimple = (allowedRoles = []) => {
  return (req, res, next) => {
    // Bypass role checking - cho ph√©p t·∫•t c·∫£ requests
    if (req.user) {
      req.user.coQuyenTruyCap = true;
    }
    
    next();
  };
};
```

**Characteristics:**
- ‚úÖ ƒê∆°n gi·∫£n, kh√¥ng logic ph·ª©c t·∫°p
- ‚úÖ Kh√¥ng ki·ªÉm tra NODE_ENV (intentionally simple)
- ‚úÖ Lu√¥n cho ph√©p access (set `coQuyenTruyCap = true`)
- ‚úÖ Kh√¥ng query database

---

### 3Ô∏è‚É£ auth.js (PRODUCTION)

**Purpose:** JWT token verification + database user validation

```javascript
const auth = async (req, res, next) => {
  try {
    const token = req.header('Authorization')?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({ success: false, message: 'Token kh√¥ng ƒë∆∞·ª£c cung c·∫•p' });
    }

    // 1. Verify JWT token
    const decoded = jwt.verify(token, process.env.JWT_SECRET || 'your-secret-key');

    // 2. Check user exists in database
    const [userRows] = await db.execute(
      'SELECT NguoiDungID, TenDayDu, Email, VaiTroHoatDongID FROM nguoidung WHERE NguoiDungID = ? AND TrangThai = "HoatDong"',
      [decoded.userId]
    );

    if (userRows.length === 0) {
      return res.status(401).json({ success: false, message: 'Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã kh√≥a' });
    }

    // 3. Get user role from database
    const [roleRows] = await db.execute(
      'SELECT vt.TenVaiTro FROM vaitro vt WHERE vt.VaiTroID = ?',
      [user.VaiTroHoatDongID]
    );

    // 4. Attach user to request
    req.user = {
      id: user.NguoiDungID,
      tenDayDu: user.TenDayDu,
      email: user.Email,
      vaiTroId: user.VaiTroHoatDongID,
      vaiTro: roleRows[0]?.TenVaiTro || 'Unknown'
    };

    next();
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({ success: false, message: 'Token kh√¥ng h·ª£p l·ªá' });
    }
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({ success: false, message: 'Token ƒë√£ h·∫øt h·∫°n' });
    }
    
    res.status(401).json({ success: false, message: 'X√°c th·ª±c th·∫•t b·∫°i' });
  }
};
```

**Characteristics:**
- ‚úÖ JWT verification v·ªõi `jsonwebtoken`
- ‚úÖ Database validation (user exists + active status)
- ‚úÖ Role lookup t·ª´ database
- ‚úÖ Error handling (JsonWebTokenError, TokenExpiredError)
- ‚úÖ Returns 401 for auth failures
- ‚úÖ Supports mock token for dev (`mock_token_dev`)

---

### 4Ô∏è‚É£ role.js (PRODUCTION)

**Purpose:** Database-based RBAC with ownership verification

```javascript
const roleMiddleware = (allowedRoles = []) => {
  return async (req, res, next) => {
    try {
      if (!req.user) {
        return res.status(401).json({
          success: false,
          message: 'Ch∆∞a x√°c th·ª±c ng∆∞·ªùi d√πng'
        });
      }

      // Handle mock user (dev bypass)
      if (req.user.isMockUser) {
        const mockRoleName = req.user.vaiTro || process.env.MOCK_ROLE_NAME || 'ChuDuAn';
        req.user.vaiTros = [mockRoleName];

        const hasMockPermission =
          allowedRoles.length === 0 || allowedRoles.includes(mockRoleName);

        if (!hasMockPermission) {
          return res.status(403).json({
            success: false,
            message: `Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Y√™u c·∫ßu vai tr√≤: ${allowedRoles.join(', ')}`
          });
        }

        req.user.coQuyenTruyCap = true;
        return next();
      }

      // Production: Query database for user roles
      const [userRoles] = await db.execute(`
        SELECT vt.TenVaiTro, nvt.VaiTroID
        FROM nguoidung_vaitro nvt
        INNER JOIN vaitro vt ON nvt.VaiTroID = vt.VaiTroID
        WHERE nvt.NguoiDungID = ? AND nvt.TrangThai = 'HoatDong'
      `, [req.user.id]);

      if (userRoles.length === 0) {
        return res.status(403).json({
          success: false,
          message: 'Ng∆∞·ªùi d√πng ch∆∞a ƒë∆∞·ª£c g√°n vai tr√≤'
        });
      }

      // Check permission
      const userRoleNames = userRoles.map(role => role.TenVaiTro);
      const hasPermission = allowedRoles.some(role => userRoleNames.includes(role));

      if (!hasPermission) {
        return res.status(403).json({
          success: false,
          message: `Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Y√™u c·∫ßu vai tr√≤: ${allowedRoles.join(', ')}`
        });
      }

      req.user.vaiTros = userRoleNames;
      req.user.coQuyenTruyCap = true;

      next();
    } catch (error) {
      console.error('L·ªói ki·ªÉm tra ph√¢n quy·ªÅn:', error);
      res.status(500).json({
        success: false,
        message: 'L·ªói server khi ki·ªÉm tra quy·ªÅn truy c·∫≠p'
      });
    }
  };
};
```

**Additional Features:**
- `ownershipMiddleware(resourceType, idParam)` - Ki·ªÉm tra ownership (TinDang, CuocHen, DuAn)
- `actAsMiddleware()` - Cho ph√©p act-as (chuy·ªÉn ƒë·ªïi vai tr√≤) v·ªõi audit log
- `requireRole(roleName)` - Helper cho single role
- `requireRoles(roleNames)` - Helper cho multiple roles

**Characteristics:**
- ‚úÖ Database queries cho roles
- ‚úÖ Ownership verification
- ‚úÖ Act-as support
- ‚úÖ Audit logging
- ‚úÖ Handles mock users (dev bypass)
- ‚úÖ Returns 403 for permission failures

---

## üîÑ S·ª≠ d·ª•ng trong Routes

### Development Mode (hi·ªán t·∫°i)

```javascript
// chuDuAnRoutes.js
const { authSimple: authMiddleware } = require('../middleware/authSimple');
const { roleSimple: roleMiddleware } = require('../middleware/roleSimple');

router.get('/tin-dang', 
  authMiddleware, 
  roleMiddleware(['ChuDuAn']), 
  ChuDuAnController.layDanhSachTinDang
);
```

### Production Mode (t∆∞∆°ng lai)

```javascript
// chuDuAnRoutes.js
const auth = require('../middleware/auth');
const { requireRole } = require('../middleware/role');

router.get('/tin-dang', 
  auth, 
  requireRole('ChuDuAn'), 
  ChuDuAnController.layDanhSachTinDang
);
```

---

## ‚öôÔ∏è Environment Configuration

### Development (.env.development)
```env
NODE_ENV=development
AUTH_MODE=simple

# Mock user config
MOCK_USER_ID=1
MOCK_ROLE_NAME=ChuDuAn
```

### Production (.env.production)
```env
NODE_ENV=production
AUTH_MODE=jwt

# JWT config
JWT_SECRET=your-secret-key-change-this-in-production
JWT_EXPIRES_IN=7d
```

---

## üéØ Migration Plan (Development ‚Üí Production)

**B∆∞·ªõc 1: Update routes**
```bash
# Find all routes using authSimple/roleSimple
grep -r "authSimple" server/routes/
grep -r "roleSimple" server/routes/
```

**B∆∞·ªõc 2: Replace imports**
```javascript
// Before (Dev)
const { authSimple: authMiddleware } = require('../middleware/authSimple');
const { roleSimple: roleMiddleware } = require('../middleware/roleSimple');

// After (Production)
const auth = require('../middleware/auth');
const { requireRole, ownershipMiddleware } = require('../middleware/role');
```

**B∆∞·ªõc 3: Update middleware usage**
```javascript
// Before (Dev)
router.get('/tin-dang', authMiddleware, roleMiddleware(['ChuDuAn']), controller);

// After (Production)
router.get('/tin-dang', auth, requireRole('ChuDuAn'), controller);
```

**B∆∞·ªõc 4: Test v·ªõi JWT token**
```bash
# Login to get token
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'

# Use token
curl -X GET http://localhost:5000/api/chu-du-an/tin-dang \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## ‚ùå Common Mistakes (ƒê√£ s·ª≠a)

### ‚ùå MISTAKE 1: Th√™m production checks v√†o authSimple
```javascript
// WRONG - authSimple.js (phi√™n b·∫£n c≈©)
if (process.env.NODE_ENV === 'production') {
  return res.status(500).json({ message: 'Server misconfiguration' });
}
```

**T·∫°i sao sai:**
- authSimple **CH·ªà** d√πng trong dev, kh√¥ng c·∫ßn check NODE_ENV
- N·∫øu d√πng trong production, ƒë√≥ l√† l·ªói c·∫•u h√¨nh routes, kh√¥ng ph·∫£i l·ªói c·ªßa middleware
- Middleware dev ph·∫£i gi·ªØ ƒë∆°n gi·∫£n, kh√¥ng c√≥ business logic

### ‚ùå MISTAKE 2: Th√™m production checks v√†o roleSimple
```javascript
// WRONG - roleSimple.js (phi√™n b·∫£n c≈©)
if (process.env.NODE_ENV === 'production') {
  return res.status(500).json({ message: 'RBAC bypass detected' });
}
```

**T·∫°i sao sai:**
- L√Ω do t∆∞∆°ng t·ª± nh∆∞ authSimple
- Dev middleware ph·∫£i t·∫≠p trung v√†o m·ªôt vi·ªác: bypass auth/role
- Production safety l√† tr√°ch nhi·ªám c·ªßa deployment config, kh√¥ng ph·∫£i middleware

### ‚úÖ CORRECT: Keep dev middleware simple

```javascript
// ‚úÖ authSimple.js (phi√™n b·∫£n m·ªõi - ƒê√öNG)
const authSimple = (req, res, next) => {
  req.user = { /* mock user */ };
  next();
};

// ‚úÖ roleSimple.js (phi√™n b·∫£n m·ªõi - ƒê√öNG)
const roleSimple = (allowedRoles = []) => {
  return (req, res, next) => {
    if (req.user) req.user.coQuyenTruyCap = true;
    next();
  };
};
```

---

## üìö T√†i li·ªáu li√™n quan

- **JWT Implementation:** `docs/CAI_DAT_CHU_DU_AN_IMPLEMENTATION.md` (Section 3.2)
- **Auth Controller:** `server/controllers/authController.js` - generateToken()
- **Frontend Integration:** `client/src/api/axiosClient.js` - Auto-attach token
- **Database Schema:** `thue_tro.sql` - nguoidung, vaitro, nguoidung_vaitro tables

---

## üîç Summary

| Aspect | authSimple/roleSimple (DEV) | auth/role (PRODUCTION) |
|--------|----------------------------|------------------------|
| **Purpose** | Bypass auth for speed | Real security |
| **Database queries** | ‚ùå None | ‚úÖ Yes (user validation, roles) |
| **JWT verification** | ‚ùå No | ‚úÖ Yes |
| **Environment check** | ‚ùå No (intentionally simple) | ‚úÖ Yes (JWT_SECRET required) |
| **Complexity** | üü¢ Very simple (~10 lines) | üî¥ Complex (~150 lines) |
| **When to use** | Development only | Production, staging |
| **Security level** | ‚ùå None (mock user) | ‚úÖ High (JWT + DB validation) |

**Key Takeaway:**
- `authSimple.js` v√† `roleSimple.js` l√† **dev bypasses** - gi·ªØ ƒë∆°n gi·∫£n, kh√¥ng th√™m production logic
- `auth.js` v√† `role.js` l√† **production middlewares** - complex, secure, database-backed
- Migration t·ª´ dev ‚Üí production: Ch·ªâ c·∫ßn thay ƒë·ªïi imports trong routes

---

**Last Updated:** 2025-01-XX
**Status:** ‚úÖ Corrected - Dev middleware reverted to simple state
