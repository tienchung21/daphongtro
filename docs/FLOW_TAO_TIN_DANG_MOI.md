# üéØ FLOW T·∫†O TIN ƒêƒÇNG M·ªöI - REDESIGN

## Ng√†y: 09/10/2025

---

## üìã FLOW M·ªöI

### B∆∞·ªõc 1: Ch·ªçn D·ª± √°n
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ch·ªçn d·ª± √°n: [Dropdown]              ‚îÇ
‚îÇ  ‚Üí Nh√† tr·ªç Minh T√¢m ‚ñº               ‚îÇ
‚îÇ  ‚Üí Nh√† tr·ªç ABC                       ‚îÇ
‚îÇ  ‚Üí ... (+) T·∫°o d·ª± √°n m·ªõi            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº (API call khi ch·ªçn)
   Load ph√≤ng c·ªßa d·ª± √°n
```

### B∆∞·ªõc 2: Ch·ªçn Ph√≤ng
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Danh s√°ch ph√≤ng c√≥ s·∫µn:                      ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ ‚òëÔ∏è Ph√≤ng 101 - 3.000.000ƒë - 25m¬≤             ‚îÇ
‚îÇ    Override gi√°: [2.800.000] ƒë (Optional)    ‚îÇ
‚îÇ    M√¥ t·∫£ ri√™ng: [∆Øu ƒë√£i SV] (Optional)       ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ ‚òê Ph√≤ng 102 - 3.500.000ƒë - 30m¬≤             ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ ‚òëÔ∏è Ph√≤ng 103 - 4.000.000ƒë - 35m¬≤             ‚îÇ
‚îÇ    Override gi√°: [] ƒë (D√πng gi√° chu·∫©n)       ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ [+ T·∫°o ph√≤ng m·ªõi]                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### B∆∞·ªõc 3: Modal T·∫°o Ph√≤ng M·ªõi (N·∫øu c·∫ßn)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ú® T·∫°o ph√≤ng m·ªõi cho d·ª± √°n              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ T√™n ph√≤ng: [104]                        ‚îÇ
‚îÇ Gi√° chu·∫©n: [3.200.000] ƒë                ‚îÇ
‚îÇ Di·ªán t√≠ch: [28] m¬≤                       ‚îÇ
‚îÇ M√¥ t·∫£: [...]                             ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ [H·ªßy]  [T·∫°o v√† th√™m v√†o tin ƒëƒÉng]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
  Ph√≤ng m·ªõi ƒë∆∞·ª£c t·∫°o + t·ª± ƒë·ªông checked
```

### B∆∞·ªõc 4: Submit Tin ƒêƒÉng
```javascript
POST /api/chu-du-an/tin-dang
{
  "DuAnID": 14,
  "TieuDe": "...",
  "MoTa": "...",
  "URL": [...],
  "PhongIDs": [
    {
      "PhongID": 1,
      "GiaTinDang": 2800000,  // Override
      "MoTaTinDang": "∆Øu ƒë√£i SV"
    },
    {
      "PhongID": 3,
      "GiaTinDang": null  // D√πng gi√° chu·∫©n
    }
  ]
}
```

---

## üíª IMPLEMENTATION

### State m·ªõi c·∫ßn th√™m
```javascript
const [danhSachPhongDuAn, setDanhSachPhongDuAn] = useState([]);
const [phongDaChon, setPhongDaChon] = useState([]);
// { PhongID, GiaTinDang (override), MoTaTinDang (override) }

const [modalTaoPhong, setModalTaoPhong] = useState(false);
```

### API c·∫ßn g·ªçi
```javascript
// 1. Load ph√≤ng khi ch·ªçn d·ª± √°n
useEffect(() => {
  if (formData.DuAnID) {
    layDanhSachPhongDuAn(formData.DuAnID);
  }
}, [formData.DuAnID]);

const layDanhSachPhongDuAn = async (duAnID) => {
  const response = await axios.get(
    `/api/chu-du-an/du-an/${duAnID}/phong`,
    { headers: { Authorization: `Bearer ${token}` } }
  );
  setDanhSachPhongDuAn(response.data.data);
};

// 2. T·∫°o ph√≤ng m·ªõi
const taoPhongMoi = async (phongData) => {
  const response = await axios.post(
    `/api/chu-du-an/du-an/${formData.DuAnID}/phong`,
    phongData,
    { headers: { Authorization: `Bearer ${token}` } }
  );
  // Reload danh s√°ch + auto check ph√≤ng m·ªõi
  layDanhSachPhongDuAn(formData.DuAnID);
  setPhongDaChon([...phongDaChon, { PhongID: response.data.data.PhongID }]);
};
```

### UI Component - Ph√≤ng Section
```jsx
<div className="section-phong">
  <h3>Ch·ªçn ph√≤ng cho tin ƒëƒÉng</h3>
  
  {danhSachPhongDuAn.map(phong => (
    <div key={phong.PhongID} className="phong-item">
      <label>
        <input
          type="checkbox"
          checked={phongDaChon.some(p => p.PhongID === phong.PhongID)}
          onChange={(e) => xuLyChonPhong(phong, e.target.checked)}
        />
        <span className="phong-info">
          {phong.TenPhong} - {phong.GiaChuan.toLocaleString()}ƒë - {phong.DienTichChuan}m¬≤
        </span>
      </label>
      
      {phongDaChon.some(p => p.PhongID === phong.PhongID) && (
        <div className="phong-override">
          <input
            type="number"
            placeholder={`Gi√° override (m·∫∑c ƒë·ªãnh: ${phong.GiaChuan})`}
            value={phongDaChon.find(p => p.PhongID === phong.PhongID).GiaTinDang || ''}
            onChange={(e) => xuLyOverrideGia(phong.PhongID, e.target.value)}
          />
          <input
            type="text"
            placeholder="M√¥ t·∫£ ri√™ng (VD: ∆Øu ƒë√£i SV)"
            value={phongDaChon.find(p => p.PhongID === phong.PhongID).MoTaTinDang || ''}
            onChange={(e) => xuLyOverrideMoTa(phong.PhongID, e.target.value)}
          />
        </div>
      )}
    </div>
  ))}
  
  <button onClick={() => setModalTaoPhong(true)}>
    + T·∫°o ph√≤ng m·ªõi
  </button>
</div>
```

---

## üîÑ LOGIC X·ª¨ L√ù

### Ch·ªçn/B·ªè ch·ªçn ph√≤ng
```javascript
const xuLyChonPhong = (phong, isChecked) => {
  if (isChecked) {
    setPhongDaChon([
      ...phongDaChon,
      {
        PhongID: phong.PhongID,
        GiaTinDang: null,  // null = d√πng gi√° chu·∫©n
        MoTaTinDang: ''
      }
    ]);
  } else {
    setPhongDaChon(phongDaChon.filter(p => p.PhongID !== phong.PhongID));
  }
};
```

### Override gi√°
```javascript
const xuLyOverrideGia = (phongID, giaMoi) => {
  setPhongDaChon(phongDaChon.map(p => 
    p.PhongID === phongID 
      ? { ...p, GiaTinDang: giaMoi ? parseInt(giaMoi) : null }
      : p
  ));
};
```

### Submit
```javascript
const xuLyGuiForm = async (e) => {
  e.preventDefault();
  
  // Validation
  if (phongDaChon.length === 0 && !formData.Gia) {
    alert('Vui l√≤ng ch·ªçn ph√≤ng ho·∫∑c nh·∫≠p gi√° ph√≤ng ƒë∆°n');
    return;
  }
  
  const payload = {
    ...formData,
    PhongIDs: phongDaChon.map(p => ({
      PhongID: p.PhongID,
      GiaTinDang: p.GiaTinDang || null,
      MoTaTinDang: p.MoTaTinDang || null
    }))
  };
  
  await TinDangService.taoTinDang(payload);
};
```

---

## üé® UX CONSIDERATIONS

1. **Khi ch∆∞a ch·ªçn d·ª± √°n:**
   - Kh√¥ng hi·ªÉn th·ªã section ch·ªçn ph√≤ng
   - Hi·ªÉn th·ªã message "Vui l√≤ng ch·ªçn d·ª± √°n tr∆∞·ªõc"

2. **Khi d·ª± √°n ch∆∞a c√≥ ph√≤ng:**
   - Hi·ªÉn th·ªã empty state
   - N√∫t "T·∫°o ph√≤ng ƒë·∫ßu ti√™n" n·ªïi b·∫≠t

3. **Override gi√°:**
   - Collapse/expand khi check/uncheck
   - Placeholder hi·ªÉn th·ªã gi√° chu·∫©n

4. **Validation:**
   - Ph·∫£i ch·ªçn √≠t nh·∫•t 1 ph√≤ng (n·∫øu kh√¥ng ph·∫£i ph√≤ng ƒë∆°n)
   - Gi√° override ph·∫£i > 0 (n·∫øu nh·∫≠p)

---

## üìù NOTES

- **Kh√¥ng x√≥a** logic c≈© c·ªßa `isNhapNhieu` / `phongs[]` (legacy, d√πng cho case ph√≤ng ƒë∆°n n·∫øu c·∫ßn)
- Section "Ch·ªçn ph√≤ng" ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ch·ªçn d·ª± √°n
- Ph√≤ng m·ªõi t·∫°o s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ch·ªçn (UX t·ªët h∆°n)
- Submit s·∫Ω g·ª≠i `PhongIDs[]` thay v√¨ `Phongs[]`

